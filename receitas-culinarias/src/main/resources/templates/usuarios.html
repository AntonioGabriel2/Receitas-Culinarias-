<!DOCTYPE html>
<html lang="pt-br"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8"/>
  <title>Usuários</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;margin:32px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    nav a, nav form button{margin-right:8px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ddd;padding:8px}
    th{background:#f5f5f5;text-align:left}
    .actions form{display:inline}
    .alert{padding:10px 12px;margin:12px 0;border-radius:6px}
    .alert-success{background:#e8f6ee;border:1px solid #b9e6c9}
    .alert-danger{background:#fdecea;border:1px solid #f5c2c7}
    .username{opacity:.8;margin-right:8px}
  </style>
</head>
<body>

<header>
  <div>
    <strong style="font-size:20px;">Usuários</strong>
  </div>

  <!-- Área de login/logout (igual ao padrão da página de receitas) -->
  <nav>
    <!-- quando NÃO logado -->
    <a sec:authorize="isAnonymous()" th:href="@{/login}">Login</a>

    <!-- quando logado -->
    <span class="username" sec:authorize="isAuthenticated()"
          th:text="${'Olá, ' + #authentication.name}">Olá, user</span>
    <form sec:authorize="isAuthenticated()" th:action="@{/logout}" method="post" style="display:inline;">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <button type="submit">Logout</button>
    </form>
  </nav>
</header>

<!-- mensagens flash -->
<div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
<div th:if="${errorMessage}"   class="alert alert-danger"  th:text="${errorMessage}"></div>

<!-- Toolbar de navegação -->
<nav style="margin-bottom:14px;">
  <a th:href="@{/}">Início</a>
  <a th:href="@{/usuarios/new}">Cadastrar novo usuário</a>
</nav>

<table>
  <thead>
  <tr>
    <th>ID</th>
    <th>Nome</th>
    <th>Email</th>
    <th>Perfil</th>
    <th colspan="4">Ações</th>
  </tr>
  </thead>

  <tbody>
  <tr th:each="u : ${usuarios}">
    <td th:text="${u.id}">1</td>
    <td th:text="${u.nome}">Fulano</td>
    <td th:text="${u.email}">fulano@exemplo.com</td>
    <td th:text="${u.perfil}">USUARIO</td>

    <!-- Detalhes (GET /usuarios/{id}) -->
    <td class="actions">
      <a th:href="@{/usuarios/{id}(id=${u.id})}">Detalhes</a>
    </td>

    <!-- Editar (ADMIN ou o próprio) -->
    <td class="actions"
        sec:authorize="hasRole('ADMIN') or (isAuthenticated() and principal?.username == #vars.u.email)">
      <a th:href="@{/usuarios/{id}/edit(id=${u.id})}">Editar</a>
    </td>

    <!-- Excluir (ADMIN) -->
    <td class="actions" sec:authorize="hasRole('ADMIN')">
      <form th:action="@{/usuarios/{id}/delete(id=${u.id})}" method="post"
            onsubmit="return confirm('Excluir este usuário?');">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button type="submit">Excluir</button>
      </form>
    </td>

    <!-- Pedir para virar cozinheiro (só o próprio e quando perfil = USUARIO) -->
    <td class="actions"
        sec:authorize="isAuthenticated() and principal?.username == #vars.u.email and #vars.u.perfil.name() == 'USUARIO'">
      <form th:action="@{/usuarios/{id}/solicitar-cozinheiro(id=${u.id})}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button type="submit" th:disabled="${u.pedidoCozinheiroPendente}">Pedir para virar cozinheiro</button>
      </form>
      <span th:if="${u.pedidoCozinheiroPendente}"> (pedido pendente)</span>
    </td>

    <!-- Aprovar / Rejeitar (ADMIN) -->
    <td class="actions" sec:authorize="hasRole('ADMIN')">
      <form th:if="${u.pedidoCozinheiroPendente}"
            th:action="@{/usuarios/{id}/aprovar-cozinheiro(id=${u.id})}"
            method="post" style="margin-right:6px;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button type="submit">Aprovar</button>
      </form>
      <form th:if="${u.pedidoCozinheiroPendente}"
            th:action="@{/usuarios/{id}/rejeitar-cozinheiro(id=${u.id})}"
            method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button type="submit">Rejeitar</button>
      </form>
    </td>
  </tr>
  </tbody>
</table>

</body>
</html>
